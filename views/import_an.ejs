<!DOCTYPE html>
<html>
<head>
  <title>PO ê²°ì œ ê´€ë¦¬</title>
  <style>
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    .paid { background-color: #e0ffe0; }
    .unpaid { background-color: #ffe0e0; }
    .form-section { margin-top: 30px; padding: 15px; border: 1px solid #aaa; border-radius: 6px; }
  </style>
</head>
<body>

<%
  // ë‚ ì§œë¥¼ MM/DD/YYYY í˜•ì‹ìœ¼ë¡œ í¬ë§·í•˜ëŠ” í•¨ìˆ˜
  function formatDate(date) {
    const d = new Date(date);
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    const yyyy = d.getFullYear();
    return `${mm}/${dd}/${yyyy}`;
  }
%>

<h3>ğŸ“Œ ì‹ ê·œ PO ë“±ë¡</h3>
<form method="POST" action="/import_an/add" style="margin-bottom: 20px;">
  <label>ë‚ ì§œ: <input type="date" name="podate" required></label>
  <label>PO ë²ˆí˜¸: <input type="text" name="pono" required></label>
  <label>ìŠ¤íƒ€ì¼: <input type="text" name="style" required></label>
  <label>ìˆ˜ëŸ‰: <input type="number" name="pcs" step="any" required></label>
  <label>ë‹¨ê°€: <input type="number" name="price" step="any" required></label>
  <button type="submit">ë“±ë¡</button>
</form>

<!-- âœ… ìˆ˜ì •, ì‚­ì œ ë¶€ë¶„ -->
<table>
  <thead>
    <tr>
      <th>ë‚ ì§œ</th>
      <th>PO ë²ˆí˜¸</th>
      <th>Style</th>
      <th>ìˆ˜ëŸ‰</th>
      <th>ë‹¨ê°€</th>
      <th>ì´ì•¡</th>
      <th>ì”ê¸ˆ</th>
      <th>ë¹„ê³ </th>
      <th>ê¸°ëŠ¥</th>
    </tr>
  </thead>
  <tbody>
    <% poList.forEach(po => { %>
      <tr>
        <td><%= formatDate(po.podate) %></td>
        <td><%= po.pono %></td>
        <td><%= po.style %></td>
        <td><%= po.pcs %></td>
        <td><%= po.price %></td>
        <td><%= po.poamount %></td>
        <td><%= po.remain %></td>
        <td><%= po.note || '-' %></td>
        <td>
          <form method="GET" action="/import_an/edit/<%= po.id %>" style="display:inline;">
            <button type="submit">ìˆ˜ì •</button>
          </form>
          <form method="POST" action="/import_an/delete/<%= po.id %>" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');" style="display:inline;">
            <button type="submit">ì‚­ì œ</button>
          </form>
        </td>
      </tr>
    <% }); %>
  </tbody>
</table>

<h2>ğŸ“‹ PO ê²°ì œ ê´€ë¦¬</h2>
<!-- âœ… ë‹¤ë¥¸ í™”ë©´ì—ì„œ ê²°ì œ ê¸°ë¡ ë³´ê¸° -->

<div style="margin: 30px 0;">
  <h4>ğŸ“… ê²°ì œ ê¸°ë¡ ë³´ê¸°</h4>

  <!-- ì „ì²´ ê²°ì œ ë³´ê¸° -->
  <form method="GET" action="/popayment/history/all" style="display: inline-block; margin-right: 20px;">
    <button type="submit">ì „ì²´ ê²°ì œ ë³´ê¸°</button>
  </form>

  <!-- ì„ íƒ ë‚ ì§œ ê²°ì œ ë³´ê¸° -->
  <form method="GET" action="/popayment/history/bydate" style="display: inline-block;">
    <label>ë‚ ì§œ ì„ íƒ:
      <input type="date" name="paydate" required>
    </label>
    <button type="submit">ì„ íƒë‚ ì§œ ê²°ì œ ë³´ê¸°</button>
  </form>
</div>
<!-- âœ… í•„í„° -->
<form method="GET" action="/import_an">
  <label>
    <input type="checkbox" name="filter" value="unpaid" <% if (filter === 'unpaid') { %>checked<% } %> >
    ì”ê¸ˆ ë‚¨ì€ POë§Œ ë³´ê¸°
  </label>
  <label>
    <input type="checkbox" name="filter" value="paid" <% if (filter === 'paid') { %>checked<% } %> >
    ê²°ì œ ì™„ë£Œëœ POë§Œ ë³´ê¸°
  </label>
  <button type="submit">í•„í„° ì ìš©</button>
</form>

<!-- âœ… PO ëª©ë¡ -->
<table>
  <thead>
    <tr>
      <th>ë‚ ì§œ</th>
      <th>PO ë²ˆí˜¸</th>
      <th>Style</th>
      <th>ìˆ˜ëŸ‰</th>
      <th>ë‹¨ê°€</th>
      <th>ì´ì•¡</th>
      <th>ì”ê¸ˆ</th>
      <th>ë¹„ê³ </th>
      <th>ì„ ìˆ˜ê¸ˆ</th>
      <th>ì”ê¸ˆ ê²°ì œ</th>
      <th>ê²°ì œ ê¸°ë¡</th>
    </tr>
  </thead>
  <tbody>
    <% poList.forEach(po => { %>
      <tr class="<%= po.remain === 0 ? 'paid' : 'unpaid' %>">
        <td><%= formatDate(po.podate) %></td>
        <td><%= po.pono %></td>
        <td><%= po.style %></td>
        <td><%= po.pcs %></td>
        <td><%= po.price %></td>
        <td><%= po.poamount %></td>
        <td><%= po.remain %></td>
        <td><%= po.note || '-' %></td>
        <td>
          <% if (po.remain > 0 && po.poamount * 0.3 <= po.remain) { %>
            <form method="POST" action="/popayment/deposit">
              <input type="hidden" name="po_id" value="<%= po.id %>">
              <input type="hidden" name="amount" value="<%= (po.poamount * 0.3).toFixed(2) %>">
              <button type="submit">30% ê²°ì œ</button>
            </form>
          <% } else { %>ì™„ë£Œ<% } %>
        </td>
        <td>
          <% if (po.remain > 0) { %>
            <form method="POST" action="/popayment/final">
              <input type="hidden" name="po_id" value="<%= po.id %>">
              <input type="hidden" name="amount" value="<%= po.remain %>">
              <button type="submit">ì”ê¸ˆ ê²°ì œ</button>
            </form>
          <% } else { %>
            ì™„ë£Œ
          <% } %>
        </td>
        
        <td>
          <form method="GET" action="/popayment/history/<%= po.id %>">
            <button type="submit">ğŸ”</button>
          </form>
        </td>
      </tr>
    <% }); %>
  </tbody>
</table>

<!-- âœ… ê²°ì œ ì¼ì ë° í™˜ìœ¨ ì…ë ¥ ì˜ì—­ -->
<div class="form-section">
  <h4>ê²°ì œ ì •ë³´ ì…ë ¥</h4>
  <form method="POST" action="/popayment/setPayInfo">
    <label>ê²°ì œì¼: <input type="date" name="paydate" required></label>
    <label>í™˜ìœ¨(USD â†’ KRW): <input type="number" name="exrate" step="0.0001" required></label>
    <button type="submit">ì…ë ¥ ì ìš©</button>
  </form>
</div>

</body>
</html>

<script>
  const dateInput = document.querySelector('input[name="podate"]');

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ì „ ê°’ ë¶ˆëŸ¬ì˜¤ê¸°
  window.addEventListener('DOMContentLoaded', () => {
    const savedDate = localStorage.getItem('poDate');
    if (savedDate && dateInput) {
      dateInput.value = savedDate;
    }
  });

  // ë‚ ì§œ ì…ë ¥ ì‹œ ì €ì¥
  dateInput?.addEventListener('change', () => {
    localStorage.setItem('poDate', dateInput.value);
  });

  // ìˆ˜ëŸ‰, ë‹¨ê°€ ì…ë ¥ì¹¸ step í™”ì‚´í‘œ ì œê±°
  /* Chrome, Safari, Edge, Opera */
  // input[type=number]::-webkit-inner-spin-button,
  // input[type=number]::-webkit-outer-spin-button {
  //   -webkit-appearance: none;
  //   margin: 0;
  // }

  // /* Firefox */
  // input[type=number] {
  //   -moz-appearance: textfield;
  // }

</script>