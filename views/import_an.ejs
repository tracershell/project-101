<!DOCTYPE html>
<html>
<head>
  <title>PO 결제 관리</title>
  <style>
    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 14px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f4f4f4; }
    .paid { background-color: #e0ffe0; }
    .unpaid { background-color: #ffe0e0; }
    .form-section { margin-top: 30px; padding: 15px; border: 1px solid #aaa; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>📋 PO 결제 관리</h2>

  <!-- ✅ 필터 -->
  <form method="GET" action="/import_an">
    <label>
      <input type="checkbox" name="filter" value="unpaid" <% if (filter === 'unpaid') { %>checked<% } %> >
      잔금 남은 PO만 보기
    </label>
    <label>
      <input type="checkbox" name="filter" value="paid" <% if (filter === 'paid') { %>checked<% } %> >
      결제 완료된 PO만 보기
    </label>
    <button type="submit">필터 적용</button>
  </form>

  <!-- ✅ PO 목록 -->
  <table>
    <thead>
      <tr>
        <th>날짜</th>
        <th>PO 번호</th>
        <th>Style</th>
        <th>수량</th>
        <th>단가</th>
        <th>총액</th>
        <th>잔금</th>
        <th>비고</th>
        <th>선수금</th>
        <th>잔금 결제</th>
        <th>결제 기록</th>
      </tr>
    </thead>
    <tbody>
      <% poList.forEach(po => { %>
        <tr class="<%= po.remain === 0 ? 'paid' : 'unpaid' %>">
          <td><%= po.podate %></td>
          <td><%= po.pono %></td>
          <td><%= po.style %></td>
          <td><%= po.pcs %></td>
          <td><%= po.price %></td>
          <td><%= po.poamount %></td>
          <td><%= po.remain %></td>
          <td><%= po.note || '-' %></td>
          <td>
            <% if (po.remain > 0 && po.poamount * 0.3 <= po.remain) { %>
              <form method="POST" action="/popayment/deposit">
                <input type="hidden" name="po_id" value="<%= po.id %>">
                <input type="hidden" name="amount" value="<%= (po.poamount * 0.3).toFixed(2) %>">
                <button type="submit">30% 결제</button>
              </form>
            <% } else { %>완료<% } %>
          </td>
          <td>
            <% if (po.remain > 0 && po.poamount * 0.3 > po.remain) { %>
              <form method="POST" action="/popayment/final">
                <input type="hidden" name="po_id" value="<%= po.id %>">
                <input type="number" name="pcs" value="<%= po.pcs %>" placeholder="수정 수량" required>
                <input type="number" name="price" value="<%= po.price %>" placeholder="수정 단가" step="0.01" required>
                <button type="submit">잔금 결제</button>
              </form>
            <% } else { %>-<% } %>
          </td>
          <td>
            <form method="GET" action="/popayment/history/<%= po.id %>">
              <button type="submit">🔍</button>
            </form>
          </td>
        </tr>
      <% }); %>
    </tbody>
  </table>

  <!-- ✅ 결제 일자 및 환율 입력 영역 -->
  <div class="form-section">
    <h4>결제 정보 입력</h4>
    <form method="POST" action="/popayment/setPayInfo">
      <label>결제일: <input type="date" name="paydate" required></label>
      <label>환율(USD → KRW): <input type="number" name="exrate" step="0.0001" required></label>
      <button type="submit">입력 적용</button>
    </form>
  </div>
</body>
</html>
